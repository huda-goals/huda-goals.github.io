<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-50 dark:bg-gray-900">
  <link rel="icon" type="image/png" href="huda.png">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Huda</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide icons for aesthetics -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Set default font to Inter and enable responsive design -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s;
        }
        /* Custom CSS for Qibla Compass */
        .qibla-compass {
            position: relative;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 4px solid #3b82f6;
            background-color: #fff;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .dark .qibla-compass {
            border-color: #4f46e5;
            background-color: #1f2937;
        }
        .qibla-needle {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 4px;
            height: 40px;
            background: #ef4444; /* Red color for pointing */
            transform-origin: 50% 100%;
            transform: translate(-50%, -100%) rotate(0deg); /* Starts pointing North (0deg) */
            transition: transform 0.5s ease-out;
            border-radius: 2px 2px 0 0;
        }
        .qibla-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 10px;
            height: 10px;
            background: #3b82f6;
            border-radius: 50%;
        }
    </style>
</head>
<body class="h-full antialiased flex flex-col items-center justify-start p-4 md:p-8">

    <!-- Main Container Card -->
    <div id="dashboard-card" class="w-full max-w-4xl bg-white dark:bg-gray-800 shadow-2xl rounded-2xl p-4 md:p-8 space-y-6 border-t-8 border-indigo-600 dark:border-indigo-500 transition-colors duration-300">
        
        <!-- Header & Top Controls -->
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center border-b pb-4 border-gray-100 dark:border-gray-700">
            <div>
                <h1 class="text-3xl font-extrabold text-gray-900 dark:text-white tracking-tight">
                    Universal Islamic Utility
                </h1>
                <p class="mt-1 text-base text-gray-500 dark:text-gray-400">
                    Your real-time dashboard for daily spiritual goals and timings.
                </p>
            </div>
            <div class="flex space-x-3 mt-4 md:mt-0">
                <!-- FEATURE 6: Dark Mode Toggle -->
                <button id="dark-mode-toggle" class="p-2 rounded-full bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors shadow-sm" title="Toggle Dark Mode">
                    <i data-lucide="moon" class="w-5 h-5"></i>
                </button>
                <!-- FEATURE 8: User ID Display -->
                <div class="p-2 text-sm bg-indigo-100 dark:bg-indigo-900 text-indigo-800 dark:text-indigo-200 rounded-lg shadow-sm font-mono">
                    ID: <span id="user-id-display">Loading...</span>
                </div>
            </div>
        </header>

        <!-- Main Grid Layout for Features (2 Columns on Desktop) -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- COLUMN 1: WIDGETS & TIMERS (lg:col-span-2) -->
            <div class="lg:col-span-2 space-y-6">

                <!-- Row 1: Time, Date & Progress -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- Existing Feature: Dynamic Clock -->
                    <div class="bg-indigo-50 dark:bg-indigo-900/50 p-4 rounded-xl text-center shadow-md dark:shadow-none transition-colors">
                        <p class="text-sm font-medium text-indigo-700 dark:text-indigo-300">Current Local Time</p>
                        <div id="local-time" class="text-2xl font-bold text-indigo-800 dark:text-indigo-100 mt-1">
                            Loading...
                        </div>
                    </div>

                    <!-- FEATURE 1: Hijri Date Converter -->
                    <div class="bg-amber-50 dark:bg-amber-900/50 p-4 rounded-xl text-center shadow-md dark:shadow-none transition-colors">
                        <p class="text-sm font-medium text-amber-700 dark:text-amber-300">Hijri Date</p>
                        <div id="hijri-date" class="text-2xl font-bold text-amber-800 dark:text-amber-100 mt-1">
                            Loading...
                        </div>
                    </div>
                    
                    <!-- FEATURE 7: Day Progress Bar -->
                    <div class="bg-green-50 dark:bg-green-900/50 p-4 rounded-xl shadow-md dark:shadow-none transition-colors">
                        <p class="text-sm font-medium text-green-700 dark:text-green-300 mb-2">Day Progress</p>
                        <div class="w-full bg-gray-200 dark:bg-gray-600 rounded-full h-3">
                            <div id="day-progress-bar" class="bg-green-500 h-3 rounded-full" style="width: 0%"></div>
                        </div>
                        <p id="day-progress-text" class="text-xs text-green-700 dark:text-green-300 mt-1 text-right">0% Complete</p>
                    </div>
                </div>
                
                <!-- Existing Feature: Iframe Widget Container -->
                <div class="w-full bg-white dark:bg-gray-700 rounded-xl overflow-hidden shadow-xl border border-gray-200 dark:border-gray-600">
                    <div class="p-3 bg-gray-50 dark:bg-gray-700 border-b border-gray-200 dark:border-gray-600">
                        <h2 class="text-lg font-semibold text-gray-800 dark:text-white">Prayer Timings (Mecca)</h2>
                    </div>
                    <!-- The user's requested iframe (hardcoded for Mecca, Makkah, Saudi Arabia) -->
                    <iframe 
                        id="iframe" 
                        title="prayerWidget" 
                        class="w-full" 
                        style="height: 358px; border: none;" 
                        scrolling="no" 
                        src="https://www.islamicfinder.org/prayer-widget/5180225/hanfi/5/0/15.0/15.0">
                    </iframe>
                </div>

            </div>

            <!-- COLUMN 2: UTILITIES & NOTES (lg:col-span-1) -->
            <div class="space-y-6">
                
                <!-- FEATURE 4: Qibla Direction Visualizer -->
                <div class="bg-white dark:bg-gray-700 p-4 rounded-xl shadow-md border border-gray-200 dark:border-gray-600 text-center">
                    <h2 class="text-xl font-semibold text-gray-800 dark:text-white mb-3 flex items-center justify-center space-x-2">
                        <i data-lucide="compass" class="w-5 h-5 text-indigo-500"></i>
                        <span>Qibla Direction (Mock)</span>
                    </h2>
                    <div class="flex justify-center items-center">
                        <div class="qibla-compass">
                            <div id="qibla-needle" class="qibla-needle" style="transform: translate(-50%, -100%) rotate(294.5deg);"></div>
                            <div class="qibla-center"></div>
                        </div>
                    </div>
                    <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">
                        <strong class="text-red-500">Needle points to Qibla</strong> (Mock angle: 294.5°)
                    </p>
                </div>
                
                <!-- FEATURE 2: Digital Tasbih Counter (Firestore Enabled) -->
                <div class="bg-white dark:bg-gray-700 p-4 rounded-xl shadow-md border border-gray-200 dark:border-gray-600 text-center">
                    <h2 class="text-xl font-semibold text-gray-800 dark:text-white mb-3 flex items-center justify-center space-x-2">
                        <i data-lucide="hand" class="w-5 h-5 text-indigo-500"></i>
                        <span>Digital Tasbih</span>
                    </h2>
                    <div id="tasbih-count" class="text-5xl font-extrabold text-indigo-600 dark:text-indigo-400 my-4 select-none">0</div>
                    <div class="flex justify-center space-x-3">
                        <button onclick="incrementTasbih()" class="flex-1 p-3 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition shadow-lg shadow-indigo-500/50">
                            + Count
                        </button>
                        <button onclick="resetTasbih()" class="p-3 bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 font-semibold rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500 transition shadow-md" title="Reset Counter">
                            <i data-lucide="rotate-ccw" class="w-5 h-5"></i>
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">Count is saved to Firestore.</p>
                </div>

                <!-- FEATURE 3: To-Do List / Daily Goals (Firestore Enabled) -->
                <div class="bg-white dark:bg-gray-700 p-4 rounded-xl shadow-md border border-gray-200 dark:border-gray-600">
                    <h2 class="text-xl font-semibold text-gray-800 dark:text-white mb-3 flex items-center space-x-2">
                        <i data-lucide="check-square" class="w-5 h-5 text-indigo-500"></i>
                        <span>Daily Goals (Firestore)</span>
                    </h2>
                    
                    <div id="todo-list" class="space-y-2 max-h-48 overflow-y-auto pr-2 mb-3">
                        <!-- To-Do items will be injected here -->
                        <p id="loading-todos" class="text-sm text-gray-400">Loading goals...</p>
                    </div>

                    <div class="flex space-x-2">
                        <input type="text" id="new-todo-input" placeholder="Add a new goal..." class="flex-1 p-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-white rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                        <button onclick="addTodo()" class="p-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 transition shadow-md">
                            <i data-lucide="plus" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- NEW FEATURE: Hadith of the Day with Refresh -->
        <div class="pt-6 border-t border-gray-100 dark:border-gray-700">
            <div class="flex justify-between items-center mb-2">
                <h3 class="text-lg font-semibold text-gray-800 dark:text-white flex items-center space-x-2">
                    <i data-lucide="book-open-text" class="w-4 h-4 text-indigo-500"></i>
                    <span>Hadith of the Day</span>
                </h3>
                <button onclick="displayRandomHadith()" class="flex items-center space-x-1 text-sm text-indigo-600 dark:text-indigo-400 hover:text-indigo-700 dark:hover:text-indigo-300 transition-colors font-medium p-1 rounded hover:bg-indigo-50 dark:hover:bg-gray-700">
                    <i data-lucide="rotate-cw" class="w-4 h-4"></i>
                    <span>Refresh</span>
                </button>
            </div>
            <blockquote class="text-gray-600 dark:text-gray-400 italic border-l-4 border-indigo-400 pl-3">
                <p id="daily-hadith-text" class="text-base font-medium">
                    Loading Hadith...
                </p>
                <cite id="daily-hadith-source" class="block mt-2 text-xs text-gray-400 not-italic">
                    
                </cite>
            </blockquote>
        </div>

    </div>

    <!-- JavaScript for Firebase, Clock, and all features (FEATURE 10: Logic) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, query, addDoc, updateDoc, deleteDoc, serverTimestamp, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- FEATURE 10: Setup Global Variables ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth;
        let userId = 'anon_user'; // Default placeholder

        if (firebaseConfig) {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        } else {
            console.error("Firebase configuration is missing.");
        }

        // --- Authentication and Initialization ---
        const initializeAppAndAuth = async () => {
            if (!auth) return;

            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase authentication error:", error);
            }
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                userId = user.uid;
                document.getElementById('user-id-display').textContent = userId.substring(0, 8) + '...';
                startRealtimeListeners();
            } else {
                // Anonymous user or signed out
                userId = crypto.randomUUID(); // Fallback UUID
                document.getElementById('user-id-display').textContent = 'ANON: ' + userId.substring(0, 8) + '...';
            }
        });

        // --- Feature Implementations ---

        // Helper for Firestore paths
        const getPrivateCollectionPath = (collectionName) => {
            return `/artifacts/${appId}/users/${userId}/${collectionName}`;
        };

        // --- Tasbih Counter (FEATURE 2) Logic ---
        const TASBIH_COLLECTION = 'tasbih_counter';
        const tasbihDocRef = () => doc(db, getPrivateCollectionPath(TASBIH_COLLECTION), 'single_count');

        const startTasbihListener = () => {
            if (!db) return;
            const unsubscribe = onSnapshot(tasbihDocRef(), (docSnapshot) => {
                const count = docSnapshot.exists() ? docSnapshot.data().count : 0;
                document.getElementById('tasbih-count').textContent = count.toString();
            }, (error) => console.error("Tasbih listener error:", error));
            return unsubscribe;
        };

        window.incrementTasbih = async () => {
            if (!db || userId === 'anon_user') return;
            try {
                await setDoc(tasbihDocRef(), { 
                    count: parseInt(document.getElementById('tasbih-count').textContent) + 1,
                    timestamp: serverTimestamp()
                }, { merge: true });
            } catch (e) {
                console.error("Error incrementing tasbih: ", e);
            }
        };

        window.resetTasbih = async () => {
            if (!db || userId === 'anon_user') return;
            try {
                await setDoc(tasbihDocRef(), { count: 0, timestamp: serverTimestamp() });
            } catch (e) {
                console.error("Error resetting tasbih: ", e);
            }
        };

        // --- To-Do List (FEATURE 3) Logic ---
        const TODO_COLLECTION = 'daily_goals';

        const startTodoListener = () => {
            if (!db) return;
            const todosRef = collection(db, getPrivateCollectionPath(TODO_COLLECTION));
            // Note: Sorting is done client-side to avoid mandatory Firestore indexes.
            const unsubscribe = onSnapshot(todosRef, (snapshot) => {
                const todos = [];
                snapshot.forEach(doc => {
                    todos.push({ id: doc.id, ...doc.data() });
                });
                // Client-side sort by timestamp/completed status
                todos.sort((a, b) => (a.completed - b.completed) || (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                renderTodos(todos);
            }, (error) => console.error("Todo listener error:", error));
            return unsubscribe;
        };

        const renderTodos = (todos) => {
            const listElement = document.getElementById('todo-list');
            listElement.innerHTML = '';
            
            if (todos.length === 0) {
                listElement.innerHTML = `<p id="loading-todos" class="text-sm text-gray-400 p-2 text-center">No goals set yet! Add one above.</p>`;
                return;
            }

            todos.forEach(todo => {
                const todoDiv = document.createElement('div');
                todoDiv.className = `flex items-center justify-between p-2 rounded-lg transition-colors ${todo.completed ? 'bg-green-100 dark:bg-green-900/50 line-through' : 'bg-gray-100 dark:bg-gray-600 hover:bg-gray-200 dark:hover:bg-gray-500'}`;
                
                todoDiv.innerHTML = `
                    <label class="flex items-center space-x-3 flex-1 cursor-pointer">
                        <input type="checkbox" ${todo.completed ? 'checked' : ''} 
                                onchange="toggleTodo('${todo.id}', ${!todo.completed})"
                                class="form-checkbox h-4 w-4 text-indigo-600 dark:text-indigo-400 rounded border-gray-300 dark:border-gray-500 focus:ring-indigo-500">
                        <span class="text-sm text-gray-800 dark:text-gray-100">${todo.text}</span>
                    </label>
                    <button onclick="deleteTodo('${todo.id}')" class="text-gray-400 hover:text-red-500 p-1 rounded transition-colors">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                `;
                listElement.appendChild(todoDiv);
            });
            lucide.createIcons(); // Re-render icons after adding new HTML
        };

        window.addTodo = async () => {
            if (!db || userId === 'anon_user') return;
            const input = document.getElementById('new-todo-input');
            const text = input.value.trim();
            if (text) {
                try {
                    const todosRef = collection(db, getPrivateCollectionPath(TODO_COLLECTION));
                    await addDoc(todosRef, {
                        text: text,
                        completed: false,
                        timestamp: serverTimestamp()
                    });
                    input.value = '';
                } catch (e) {
                    console.error("Error adding document: ", e);
                }
            }
        };

        window.toggleTodo = async (id, completedStatus) => {
            if (!db || userId === 'anon_user') return;
            try {
                const docRef = doc(db, getPrivateCollectionPath(TODO_COLLECTION), id);
                await updateDoc(docRef, { completed: completedStatus });
            } catch (e) {
                console.error("Error updating todo: ", e);
            }
        };

        window.deleteTodo = async (id) => {
            if (!db || userId === 'anon_user') return;
            try {
                const docRef = doc(db, getPrivateCollectionPath(TODO_COLLECTION), id);
                await deleteDoc(docRef);
            } catch (e) {
                console.error("Error deleting todo: ", e);
            }
        };

        // --- Date/Time & Progress (Existing + FEATURE 1 + FEATURE 7) ---

        /**
         * Converts Gregorian date to a simple approximation of the Hijri date.
         */
        function toHijriDate(gDate) {
            const hijriDate = new Intl.DateTimeFormat('en-US-u-ca-islamic', {
                day: 'numeric', month: 'long', year: 'numeric'
            }).format(gDate);
            return hijriDate;
        }

        function updateClockAndProgress() {
            const now = new Date();
            const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            const dateString = now.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            
            // Update Clock
            const timeElement = document.getElementById('local-time');
            if (timeElement) {
                timeElement.innerHTML = `${timeString} <span class="text-base font-normal text-indigo-600 dark:text-indigo-300 block mt-1">${dateString}</span>`;
            }

            // Update Hijri Date (FEATURE 1)
            const hijriElement = document.getElementById('hijri-date');
            if (hijriElement) {
                hijriElement.textContent = toHijriDate(now);
            }

            // Update Day Progress Bar (FEATURE 7)
            const totalSecondsInDay = 24 * 60 * 60;
            const currentSeconds = now.getHours() * 3600 + now.getMinutes() * 60 + now.getSeconds();
            const progress = (currentSeconds / totalSecondsInDay) * 100;

            const progressBar = document.getElementById('day-progress-bar');
            const progressText = document.getElementById('day-progress-text');

            if (progressBar) {
                progressBar.style.width = `${progress}%`;
                progressText.textContent = `${progress.toFixed(2)}% Complete`;
            }
        }

        // --- Dark Mode (FEATURE 6) Logic ---
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        const root = document.documentElement;

        const setDarkMode = (isDark) => {
            if (isDark) {
                root.classList.add('dark');
                localStorage.setItem('theme', 'dark');
                darkModeToggle.querySelector('i').setAttribute('data-lucide', 'sun');
            } else {
                root.classList.remove('dark');
                localStorage.setItem('theme', 'light');
                darkModeToggle.querySelector('i').setAttribute('data-lucide', 'moon');
            }
            lucide.createIcons();
        };

        const toggleDarkMode = () => {
            const isDark = root.classList.contains('dark');
            setDarkMode(!isDark);
        };

        // Load initial theme
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            setDarkMode(true);
        } else {
            setDarkMode(false);
        }
        darkModeToggle.addEventListener('click', toggleDarkMode);


        // --- Hadith of the Day (NEW FEATURE) Logic ---
        const HADITHS = [
            {
                text: "Actions are but by intentions, and every man shall have but that which he intended.",
                source: "Sahih al-Bukhari, 1"
            },
            {
                text: "None of you truly believes until he wishes for his brother what he wishes for himself.",
                source: "Sahih al-Bukhari, 13"
            },
            {
                text: "The best among you are those who have the best manners and character.",
                source: "Sahih al-Bukhari, 6029"
            },
            {
                text: "Verily, Allah loves those who turn to Him in repentance and loves those who purify themselves.",
                source: "Sunan al-Tirmidhi, 3109"
            },
            {
                text: "A kind word is a form of charity.",
                source: "Sahih al-Bukhari, 2827"
            },
            {
                text: "Do not hate one another, nor be jealous of one another; and O slaves of Allah, be brethren.",
                source: "Sahih Muslim, 2559a"
            },
            {
                text: "The Muslim is the one from whose tongue and hand the people are safe.",
                source: "Sahih al-Bukhari, 10"
            },
            {
                text: "The strong man is not the good wrestler; the strong man is only the one who controls himself when he is angry.",
                source: "Sahih al-Bukhari, 6114"
            }
        ];

        window.displayRandomHadith = () => {
            const randomIndex = Math.floor(Math.random() * HADITHS.length);
            const hadith = HADITHS[randomIndex];

            const textElement = document.getElementById('daily-hadith-text');
            const sourceElement = document.getElementById('daily-hadith-source');

            if (textElement && sourceElement) {
                textElement.textContent = hadith.text;
                sourceElement.textContent = `— ${hadith.source}`;
            }
        };


        // --- Final Execution ---

        function startRealtimeListeners() {
            // Start listeners only after Auth state is stable
            startTasbihListener();
            startTodoListener();
        }

        // Initialize and start recurring updates
        window.onload = () => {
            initializeAppAndAuth();
            updateClockAndProgress();
            setInterval(updateClockAndProgress, 1000);
            displayRandomHadith(); // Call on load to show the first Hadith
            lucide.createIcons(); // Initialize all Lucide icons
        };
    </script>

</body>
</html>
